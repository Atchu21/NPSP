<apex:page controller="GE_PaymentServices" showHeader="false" applyHtmlTag="true" applyBodyTag="false">

    <head>
        <apex:slds />
    </head>

    <article class='slds-scope'>
        <form onsubmit="handleForm(event)">
            <div id="payments"></div>
        </form>
    </article>

    <script src="{!elevateSDKURL}"></script>
    <script>
        const sfdo = new sfdoPaymentsJsSdk();
        const lightningOrigin = buildLightningOrigin();
        const DEFAULT_NAME_ON_CARD = '[Not Provided]';
        let nameOnCard = DEFAULT_NAME_ON_CARD;

        function isLoaded() {
            const message = JSON.stringify({ isLoaded: true });
            postMessage(message);
        }

        function isReadyToMount() {
            const message = JSON.stringify({ isReadyToMount: true });
            postMessage(message);
        }

        /*******************************************************************************
        * @description Method listens for messages from a credit card widget LWC
        * Event.data contains at least an "action" and optionally a "nameOnCard" value.
        */
        window.onmessage = function (event) {
            if (event && event.origin !== lightningOrigin) {
                // Reject any messages from an unexpected origin
                return;

            } else if (event.data && event.data.action === 'createToken') {
                if (event.data.nameOnCard) {
                    nameOnCard = event.data.nameOnCard;
                } else {
                    nameOnCard = DEFAULT_NAME_ON_CARD;
                }

                handleTokenCreation();
            } else if (event.data && event.data.action === 'switchPaymentMethod') {
                const paymentMethod = event.data.paymentMethod === 'ACH' ?
                    sfdo.PaymentMethod.ACH :
                    sfdo.PaymentMethod.CREDIT_CARD;

                sfdo.setPaymentMethod(paymentMethod);
            } else if (event.data && event.data.action === 'mount') {
                const paymentMethod = event.data.paymentMethod === 'ACH' ?
                    sfdo.PaymentMethod.ACH :
                    sfdo.PaymentMethod.CREDIT_CARD;

                handleMounting(paymentMethod);
            }
        }

        const styles = `
            .logo {
                left: 8px !important;
            }
            .fieldset.cc-number {
                padding-left: 0;
                padding-right: 1rem;
            }
            .fieldset.exp {
                padding-left: 0;
                padding-right: 1rem;
            }
            .fieldset.cvc {
                padding: 0;
            }
            .fieldset.account-number {
                padding-left: 0;
                padding-right: 1rem;
            }
            .error-wrapper.fieldset.exp {
                max-width: fit-content;
            }
            .error-wrapper.fieldset.cvc {
                max-width: fit-content;
            }
        `;

        function handleMounting(paymentMethod) {
            const config = {
                id: 'payments',
                clientId: '{!productId}',
                gatewayId: '{!gatewayIds}',
                merchantId: '{!merchantIds}',
                designSystem: 'Lightning',
                paymentMethod: paymentMethod,
                styles: styles
            };

            sfdo.mount(config)
                .then(() => {
                    isLoaded();
                    setTimeout(function () {
                        isLoaded();
                    }, 3000);
                });
        }

        /*******************************************************************************
        * @description Creates a token and posts the response to a credit card widget LWC
        */
        function handleTokenCreation() {
            const auth = {
                jwt: '{!jwtForToken}',
                userName: '{!$User.Username}'
            };
            const tokenConfig = {
                auth: auth,
                nameOnCard: nameOnCard
            };

            sfdo.createToken(tokenConfig)
                .then(function response(resp) {
                    if (resp.token) {
                        // Send token to lwc
                        const successString = JSON.stringify({ token: resp.token });
                        postMessage(successString);

                    } else if (resp.error) {
                        // Response contains the error, send it to lwc
                        postMessage(JSON.stringify(resp));
                    }
                })
                .catch(function handleError(err) {
                    // Send error to lwc
                    const errorString = JSON.stringify(err);
                    postMessage(errorString);
                });
        }

        /*******************************************************************************
        * @description Posts messages to a credit card widget LWC
        *
        * @param {string} message: String to pass to the LWC
        */
        function postMessage(message) {
            window.top.postMessage(message, lightningOrigin);
        }

        function buildLightningOrigin() {
            const hostname = window.location.hostname;
            const arr = hostname.split(".");
            let domain = arr[0].replace('--npsp', '');
            domain = domain.replace('--c', '');

            return `https://${domain}.lightning.force.com`;
        }

        window.onload = isReadyToMount();
    </script>

</apex:page>